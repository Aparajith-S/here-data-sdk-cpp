# Write example

This example shows how to write your own data to OLP stream layer using the HERE OLP Edge SDK C++.

Before you run the example, you have to replace the placeholders in `examples/dataservice-write/example.cpp` with your app key, app secret, catalog HRN and layer:

```cpp
const std::string gKeyId("");            // your here.access.key.id
const std::string gKeySecret("");        // your here.access.key.secret
const std::string gCatalogHRN("");       // your catalog HRN where to write to
const std::string gLayer("");            // layer name inside catalog to use
```

## Building and running

Configure the project with `EDGE_SDK_BUILD_EXAMPLES` set to `ON` to enabled examples `CMake` targets:

```bash
mkdir build && cd build
cmake -DEDGE_SDK_BUILD_EXAMPLES=ON ..
```

To build the example, run the following command in the `build` folder:

```bash
cmake --build . --target dataservice-write-example
```

To execute the example, run:

```bash
./examples/dataservice-write/dataservice-write-example
```

If everything is fine, you would see `Publish Successful - TraceID: <TraceId generated by the platform>`.

## How it works

### StreamLayerClient

The `StreamLayerClient` class provides an interface for the ingestion of OLP data, and defines the following operations:

* `PublishData`: Publish data into an OLP stream layer.
* `PublishSdii`: Publish list of SDII messages into an OLP stream layer.

To create a `StreamLayerClient` provide the corresponding HRN and a preconfigured `OlpClientSettings`:

```cpp
// Setup AuthenticationSettings with a default token provider that will
// retrieve an OAuth 2.0 token from OLP.
olp::client::AuthenticationSettings authSettings;
authSettings.provider =
    olp::authentication::TokenProviderDefault(gKeyId, gKeySecret);

// Setup OlpClientSettings and provide it to the StreamLayerClient.
olp::client::OlpClientSettings clientSettings;
clientSettings.authentication_settings = authSettings;

auto client = std::make_shared<StreamLayerClient>(
    olp::client::HRN{gCatalogHRN}, clientSettings);
```

The `StreamLayerClient` class pulls together all the different settings which can be used to customize the behavior of the client.

* `retry_settings`: Sets the `olp::client::RetrySettings` to be used.
* `proxy_settings`: Sets the `olp::authentication::NetworkProxySettings` to be used.
* `authentication_settings`: Sets the `olp::client::AuthenticationSettings` to be used.
* `network_async_handler`: Sets the handler for asynchronous execution of network requests.

For basic usage, we need to specify only `authentication_settings`.

### Publish data into stream layer

To publish data into stream layer you to create `PublishDataRequest`. The `PublishDataRequest` class is used to specify the parameters of the `PublishData` function, including the following:

* `WithData`: Specify the data to be uploaded to the layer.
* `WithLayerId`: Specify the stream layer to upload data to.
* `WithTraceId`: Set the trace id for the request.
* `WithBillingTag`: Set the billing tag for the request.
* `WithChecksum`: Set the checksum for the partition.

```cpp
// Create a publish data request
auto request = PublishDataRequest().WithData(buffer).WithLayerId(gLayer);
```

Then pass it to the `StreamLayerClient` via `PublishData` method:

```cpp
// Write data to OLP Stream Layer using StreamLayerClient
auto futureResponse = client->PublishData(request);
```

The execution result is a `CancellableFuture` that contains `PublishDataResponse` object. The `PublishDataResponse` class holds details of the completed operation, and should be used to determine operation success and access resultant data.

* `IsSuccessful`: Returns true if this response is considered successful, false otherwise.
* `GetResult`: Returns the resultant data (`olp::dataservice::write::PublishDataResult`) in the case that the operation is successful.
* `GetError`: Contains information about the error that occurred in the case of error in a `olp::client::ApiError` object.

The `PublishDataResult` class returns details of the request result, including:

* `GetTraceID`: Get the trace id of the request.

```cpp
// Wait for response
auto response = futureResponse.GetFuture().get();

// Check the response
if (!response.IsSuccessful()) {
    LOG_INFO_F("write-example",
               "Error writing data - HTTP Status: %d Message: %s",
               response.GetError().GetHttpStatusCode(),
               response.GetError().GetMessage().c_str());
    return -1;
} else {
    LOG_ERROR_F("write-example", "Publish Successful - TraceID: %s",
                response.GetResult().GetTraceID().c_str());
}
```
